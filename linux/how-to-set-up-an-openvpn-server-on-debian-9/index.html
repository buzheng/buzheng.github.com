<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>如何在 Debian 9 上设置 OpenVPN 服务器 |  不争笔记</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.59.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.c82345eb542d5eac3fb4abd80d78ec42.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="如何在 Debian 9 上设置 OpenVPN 服务器" />
<meta property="og:description" content="无论您是想在不信任的公共 Wi-Fi 网络上连接时安全可靠地访问互联网，还是想绕过地域限制查看内容，或者想允许您的同事在远程工作时安全地连接到您的公司网络，使用 VPN 是最佳解决方案。

VPN 允许您连接到远程 VPN 服务器，使您的连接加密和安全，并通过保持您的流量数据私密来匿名浏览网页。

您可以选择许多商业 VPN 提供商，但您永远无法保证提供商不会记录您的活动。最安全的选择是设置自己的 VPN 服务器。

本教程将介绍如何在 Debian 9 上安装和配置 OpenVPN 。我们还将向您展示如何生成客户端证书和创建配置文件

OpenVPN 是一个功能齐全的开源安全套接字层 (SS)  VPN 解决方案。它使用 SSL/TLS 协议实现 OSI 第 2 层或第 3 层安全网络扩展。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/linux/how-to-set-up-an-openvpn-server-on-debian-9/" />
<meta property="article:published_time" content="2019-03-21T10:00:00+08:00" />
<meta property="article:modified_time" content="2019-03-21T10:00:00+08:00" />
<meta itemprop="name" content="如何在 Debian 9 上设置 OpenVPN 服务器">
<meta itemprop="description" content="无论您是想在不信任的公共 Wi-Fi 网络上连接时安全可靠地访问互联网，还是想绕过地域限制查看内容，或者想允许您的同事在远程工作时安全地连接到您的公司网络，使用 VPN 是最佳解决方案。

VPN 允许您连接到远程 VPN 服务器，使您的连接加密和安全，并通过保持您的流量数据私密来匿名浏览网页。

您可以选择许多商业 VPN 提供商，但您永远无法保证提供商不会记录您的活动。最安全的选择是设置自己的 VPN 服务器。

本教程将介绍如何在 Debian 9 上安装和配置 OpenVPN 。我们还将向您展示如何生成客户端证书和创建配置文件

OpenVPN 是一个功能齐全的开源安全套接字层 (SS)  VPN 解决方案。它使用 SSL/TLS 协议实现 OSI 第 2 层或第 3 层安全网络扩展。">


<meta itemprop="datePublished" content="2019-03-21T10:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-03-21T10:00:00&#43;08:00" />
<meta itemprop="wordCount" content="5885">



<meta itemprop="keywords" content="debian,vpn," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何在 Debian 9 上设置 OpenVPN 服务器"/>
<meta name="twitter:description" content="无论您是想在不信任的公共 Wi-Fi 网络上连接时安全可靠地访问互联网，还是想绕过地域限制查看内容，或者想允许您的同事在远程工作时安全地连接到您的公司网络，使用 VPN 是最佳解决方案。

VPN 允许您连接到远程 VPN 服务器，使您的连接加密和安全，并通过保持您的流量数据私密来匿名浏览网页。

您可以选择许多商业 VPN 提供商，但您永远无法保证提供商不会记录您的活动。最安全的选择是设置自己的 VPN 服务器。

本教程将介绍如何在 Debian 9 上安装和配置 OpenVPN 。我们还将向您展示如何生成客户端证书和创建配置文件

OpenVPN 是一个功能齐全的开源安全套接字层 (SS)  VPN 解决方案。它使用 SSL/TLS 协议实现 OSI 第 2 层或第 3 层安全网络扩展。"/>

  </head>

  <body class="ma0 sans-serif bg-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw4 hover-white no-underline white-90 dib">
      不争笔记
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3 mv0">
          
          <li class="list f5 fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/babylonjs/" title="BabylonJS 教程 page">
              BabylonJS 教程
            </a>
          </li>
          
          <li class="list f5 fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/linux/" title="Linux 教程 page">
              Linux 教程
            </a>
          </li>
          
          <li class="list f5 fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/post/" title="博文 page">
              博文
            </a>
          </li>
          
        </ul>
      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mv4 w-100">
      <h1 class="f2 mb3">如何在 Debian 9 上设置 OpenVPN 服务器</h1>
      <div class="gray">
      
        <time class="f6 dib tracked" datetime="2019-03-21T10:00:00&#43;08:00">2019年3月21日</time>
        
        
          <span class="mh2 f7">•</span>
          <span class="f6 dib tracked">约 5900 字</span>
          <span class="f6 dib tracked">, 预计阅读时间 14 分钟</span>
        
      </div>
    </header>
    
    <section class="nested-copy-line-height lh-copy f4 nested-links nested-img dark-gray w-70-l pr3">
      <div class="x-md">
          
          
          
  
          
          
          
  
          <p>无论您是想在不信任的公共 Wi-Fi 网络上连接时安全可靠地访问互联网，还是想绕过地域限制查看内容，或者想允许您的同事在远程工作时安全地连接到您的公司网络，使用 VPN 是最佳解决方案。</p>

<p>VPN 允许您连接到远程 VPN 服务器，使您的连接加密和安全，并通过保持您的流量数据私密来匿名浏览网页。</p>

<p>您可以选择许多商业 VPN 提供商，但您永远无法保证提供商不会记录您的活动。最安全的选择是设置自己的 VPN 服务器。</p>

<p>本教程将介绍如何在 Debian 9 上安装和配置 OpenVPN 。我们还将向您展示如何生成客户端证书和创建配置文件</p>

<p>OpenVPN 是一个功能齐全的开源安全套接字层 (SS)  VPN 解决方案。它使用 SSL/TLS 协议实现 OSI 第 2 层或第 3 层安全网络扩展。</p>

<h2 id="先决条件">先决条件</h2>

<p>要完成本教程，您需要：</p>

<ul>
<li>使用<a href="/linux/how-to-create-a-sudo-user-on-debian/">sudo 访问</a>配置了基本 <!--link:how-to-setup-a-firewall-with-ufw-on-debian-9-->UFW 防火墙<!--link-->的 Debian 9 服务器，我们将在其上安装 OpenVPN 服务。</li>
<li>单独的专用计算机用作 CA （证书颁发机构）。如果您不想为 CA 使用专用计算机，则可以在 OpenVPN 服务器或本地计算机上构建 CA.  构建完 CA 后，建议将 CA 目录移动到安全或离线的位置。</li>
</ul>

<p>本教程假定 CA 位于单独的 Debian 9 计算机上。如果您将服务器用作 CA ，则将按相同的步骤操作即可（稍作修改）。</p>

<p>我们使用单独的 CA 计算机来防止攻击者渗入服务器。如果攻击者能够访问到 CA 私钥，他们可以使用它来签署新证书，这将使他们能够访问 VPN 服务器。</p>

<h2 id="使用-easyrsa-构建-ca">使用 EasyRSA 构建 CA.</h2>

<p>第一步是构建公钥基础结构 (<a href="https://en.wikipedia.org/wiki/Public_key_infrastructure">PKI</a>)，包括以下内容：</p>

<ul>
<li>证书颁发机构 (CA)证书和私钥。</li>
<li>我们的 CA 颁发的服务器的单独证书和私钥对。</li>
<li>我们的 CA 颁发的每个客户的单独证书和私钥对。</li>
</ul>

<p>正如先决条件中所述的安全的原因，我们将在独立计算机上构建 CA.
<!--未完待续-->
我们将使用名为 EasyRSA 的 CLI 实用程序来创建 CA ，生成证书请求和签署证书。</p>

<p>在 CA 计算机上执行以下步骤：</p>

<ol>
<li><p>首先使用以下 wget 命令从 <a href="https://github.com/OpenVPN/easy-rsa">Github 存储库</a>下载最新版本的 EasyRSA ：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="o">&amp;&amp;</span> wget https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.6/EasyRSA-unix-v3.0.6.tgz</code></pre></div></li>

<li><p>下载完成后，<!--link:how-to-create-and-extract-archives-using-the-tar-command-in-linux-->解压缩存档<!--link-->：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">tar xzf EasyRSA-unix-v3.0.6.tgz</code></pre></div></li>

<li><p>导航到 EasyRSA 目录并通过复制文件 <code>vars.example</code> 创建一个配置文件 vars ：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6/
cp vars.example vars</code></pre></div></li>

<li><p>打开文件 <code>~/EasyRSA-v3.0.6/vars</code> 取消注释并更新以下条目以匹配您的信息。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">nano ~/EasyRSA-v3.0.6/vars</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">set_var EASYRSA_REQ_COUNTRY    <span class="s2">&#34;US&#34;</span>
set_var EASYRSA_REQ_PROVINCE   <span class="s2">&#34;Pennsylvania&#34;</span>
set_var EASYRSA_REQ_CITY       <span class="s2">&#34;Pittsburgh&#34;</span>
set_var EASYRSA_REQ_ORG        <span class="s2">&#34;Linuxize&#34;</span>
set_var EASYRSA_REQ_EMAIL      <span class="s2">&#34;admin@linuxize.com&#34;</span>
set_var EASYRSA_REQ_OU         <span class="s2">&#34;Community&#34;</span></code></pre></div></li>

<li><p>在生成 CA 密钥对之前，您首先需要使用以下命令初始化新的 PKI ：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">./easyrsa init-pki</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">init-pki complete<span class="p">;</span> you may now create a CA or requests.
Your newly created PKI dir is: /home/causer/EasyRSA-v3.0.6/pki</code></pre></div></li>

<li><p>下一步是构建 CA ：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">./easyrsa build-ca</code></pre></div>
<blockquote>
<p>如果您不希望每次签署证书时都提示输入密码，请运行命令时 <code>build-ca</code> 使用 <code>nopass</code> 选项： <code>./easyrsa build-ca nopass</code> 。</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">...
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
...
-----
Common Name <span class="o">(</span>eg: your user, host, or server name<span class="o">)</span> <span class="o">[</span>Easy-RSA CA<span class="o">]</span>:

CA creation <span class="nb">complete</span> and you may now import and sign cert requests.
Your new CA certificate file <span class="k">for</span> publishing is at:
/home/causer/EasyRSA-v3.0.6/pki/ca.crt</code></pre></div>
<p>系统将要求您为 CA 密钥设置密码，并为 CA 输入通用名称。</p>

<p>完成后，该脚本将创建两个文件: CA 公共证书 <code>ca.crt</code> 和 CA 私钥 <code>ca.key</code> 。</p>

<p>我们将使用证书颁发机构 (CA)文件为我们的 OpenVPN 服务器和客户端签署证书请求。</p></li>
</ol>

<h2 id="安装-openvpn-和-easyrsa">安装 OpenVPN 和 EasyRSA</h2>

<p>下一步是安装 OpenVPN 软件包，软件包在 Debian 的存储库中可用，并在 OpenVPN 服务器上下载最新版本的 EasyRSA 。</p>

<p>在 OpenVPN 服务器上执行以下步骤。</p>

<ol>
<li><p>安装 OpenVPN 非常简单，只需在 OpenVPN 服务器上运行以下命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt update
sudo apt install openvpn</code></pre></div></li>

<li><p>下载最新版本的 EasyRSA ：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> <span class="o">&amp;&amp;</span> wget https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.6/EasyRSA-unix-v3.0.6.tgz</code></pre></div>
<p>下载完成后，输入以下命令以解压缩存档：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">tar xzf EasyRSA-unix-v3.0.6.tgz</code></pre></div>
<p>虽然我们已经在 CA 机器上初始化了 PKI ，但我们还需要在 OpenVPN 服务器上创建一个新的 PKI 。为此，请使用与以前相同的命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6/
./easyrsa init-pki</code></pre></div>
<p>如果您仍然想知道为什么我们需要安装两个 EasyRSA ，那是因为我们将使用此 EasyRSA 实例生成证书请求，这些证书请求将使用 CA 计算机上的 EasyRSA 实例进行签名。</p>

<p>这可能听起来很复杂，而且很容易混淆，但是一旦你阅读完整个教程，你就会发现它并不复杂。</p></li>
</ol>

<h2 id="创建-diffie-hellman-和-hmac-密钥">创建 Diffie-Hellman 和 HMAC 密钥</h2>

<p>在本节中，我们将生成一个强密的 Diffie-Hellman 密钥，该密钥将在密钥交换期间使用，并且 HMAC 签名文件将为连接添加额外的安全层。</p>

<ol>
<li><p>首先导航到 OpenVPN 服务器上的 EasyRSA 目录。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6/</code></pre></div></li>

<li><p>生成 Diffie-Hellman 密钥：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">./easyrsa gen-dh</code></pre></div>
<p>该脚本将生成 2048 位长的 DH 参数。根据您的系统资源，生成密钥可能需要一些时间。完成后，屏幕上将显示以下信息：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">DH parameters of size <span class="m">2048</span> created at /home/serveruser/EasyRSA-v3.0.6/pki/dh.pem</code></pre></div>
<p>将 <code>dh.pem</code> 文件复制到 <code>/etc/openvpn</code> 目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo cp ~/EasyRSA-v3.0.6/pki/dh.pem /etc/openvpn/</code></pre></div></li>

<li><p>生成 HMAC 签名：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">openvpn --genkey --secret ta.key</code></pre></div>
<p>完成后将 <code>ta.key</code> 文件复制到 <code>/etc/openvpn</code> 目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo cp ~/EasyRSA-v3.0.6/ta.key /etc/openvpn/</code></pre></div></li>
</ol>

<h2 id="创建服务器证书和私钥">创建服务器证书和私钥</h2>

<p>本节介绍如何为 OpenVPN 服务器生成私钥和证书请求。</p>

<ol>
<li><p>导航到 OpenVPN 服务器上的 EasyRSA 目录，并为服务器和证书请求文件生成新的私钥：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6/
./easyrsa gen-req server1 nopass</code></pre></div>
<p>我们正在使用 <code>nopass</code> 参数，因为我们想要在没有密码输入的情况下启动 OpenVPN 服务器。同样在此示例中，我们将 <code>server1</code> 用作服务器名称（实体）标识符。如果为服务器选择其他名称，请不要忘记调整以下说明中使用的服务器名称。</p>

<p>该命令将创建两个文件，一个私钥 (<code>server1.key</code>）和一个证书请求文件 (<code>server1.req</code>）。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">-----
Common Name <span class="o">(</span>eg: your user, host, or server name<span class="o">)</span> <span class="o">[</span>server1<span class="o">]</span>:

Keypair and certificate request completed. Your files are:
req: /home/serveruser/EasyRSA-v3.0.6/pki/reqs/server1.req
key: /home/serveruser/EasyRSA-v3.0.6/pki/private/server1.key</code></pre></div></li>

<li><p>将私钥复制到 <code>/etc/openvpn</code> 目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo cp ~/EasyRSA-v3.0.6/pki/private/server1.key /etc/openvpn/</code></pre></div></li>

<li><p>将证书请求文件传输到 CA 计算机：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">scp ~/EasyRSA-v3.0.6/pki/reqs/server1.req causer@your_ca_ip:/tmp</code></pre></div>
<p>在此示例中，我们使用 <!--link:how-to-use-scp-command-to-securely-transfer-files-->scp<!--link--> 传输文件，您也可以使用 ssh 之上的 <a href="/linux/how-to-use-rsync-for-local-and-remote-data-transfer-and-synchronization/">rsync</a> 或任何其他安全方法。</p></li>

<li><p>登录到您的 <strong>CA 计算机</strong>，切换到 EasyRSA 目录并导入证书请求文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6
./easyrsa import-req /tmp/server1.req server1</code></pre></div>
<p>第一个参数是证书请求文件的路径，第二个参数是服务器名称。在我们的例子中，服务器名称是 <code>server1</code> 。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">The request has been successfully imported with a short name of: server1
You may now use this name to perform signing operations on this request.</code></pre></div>
<p>此命令只是将请求文件复制到 <code>pki/reqs</code> 目录中。</p></li>

<li><p>仍在 <strong>CA 计算机</strong>上的 EasyRSA 目录中，运行以下命令以对请求进行签名：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6
./easyrsa sign-req server server1</code></pre></div>
<p>第一个参数可以是 <code>server</code> 或者 <code>client</code> 第二个参数是服务器名称。</p>

<p>系统将提示您验证请求是否来自可信来源。输入 <code>yes</code> 并按 <code>enter</code> 确认：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">You are about to sign the following certificate.
Please check over the details shown below <span class="k">for</span> accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
<span class="nb">source</span> or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate <span class="k">for</span> <span class="m">1080</span> days:

<span class="nv">subject</span><span class="o">=</span>
    <span class="nv">commonName</span>                <span class="o">=</span> server1

Type the word <span class="s1">&#39;yes&#39;</span> to <span class="k">continue</span>, or any other input to abort.
Confirm request details: yes
...</code></pre></div>
<p>如果您的 CA 密钥受密码保护，系统将提示您输入密码。验证后，脚本将生成 SSL 证书并打印完整路径。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">...
Certificate is to be certified <span class="k">until</span> Sep <span class="m">17</span> <span class="m">10</span>:54:48 <span class="m">2021</span> GMT <span class="o">(</span><span class="m">1080</span> days<span class="o">)</span>

Write out database with <span class="m">1</span> new entries
Data Base Updated

Certificate created at: /home/causer/EasyRSA-v3.0.6/pki/issued/server1.crt</code></pre></div></li>

<li><p>下一步是将签名的证书 <code>server1.crt</code> 和 <code>ca.crt</code> 文件传输回 OpenVPN 服务器。您可以再次使用 <code>scp</code> ， <code>rsync</code> 或者任何其他安全的方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">scp ~/EasyRSA-v3.0.6/pki/issued/server1.crt serveruser@your_server_ip:/tmp
scp ~/EasyRSA-v3.0.6/pki/ca.crt serveruser@your_server_ip:/tmp</code></pre></div></li>

<li><p>登录到您的 OpenVPN 服务器，并将 <code>server1.crt</code> 和 <code>ca.crt</code> 文件移动到 <code>/etc/openvpn/</code> 目录中：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo mv /tmp/<span class="o">{</span>server1,ca<span class="o">}</span>.crt /etc/openvpn/</code></pre></div></li>
</ol>

<p>完成本节中概述的步骤后，您的 OpenVPN 服务器上应该有以下新文件：</p>

<ul>
<li><code>/etc/openvpn/ca.crt</code></li>
<li><code>/etc/openvpn/dh.pem</code></li>
<li><code>/etc/openvpn/ta.key</code></li>
<li><code>/etc/openvpn/server1.crt</code></li>
<li><code>/etc/openvpn/server1.key</code></li>
</ul>

<h2 id="配置-openvpn-服务">配置 OpenVPN 服务</h2>

<p>现在您已获得 CA 签署的服务器证书并传输到 <strong>OpenVPN 服务器</strong>，现在可以配置 OpenVPN 服务了。</p>

<p>我们将从示例配置文件开始，该文件随 OpenVPN 安装包提供，然后将自己的自定义配置选项添加到其中。</p>

<p>首先将配置文件解压缩到 <code>/etc/openvpn/</code> 目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo sh -c <span class="s2">&#34;gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz &gt; /etc/openvpn/server1.conf&#34;</span></code></pre></div>
<p>使用您喜欢的文本编辑器打开文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo nano /etc/openvpn/server1.conf</code></pre></div>
<ul>
<li><p>找到 Certificate ， Key 和 DH 参数指令并更改文件名：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">cert server1.crt
key server1.key 

dh dh.pem</code></pre></div></li>

<li><p>要通过 VPN 重定向客户端流量，请查找并取消注释 <code>redirect-gateway</code> 和 <code>dhcp-option</code> 选项：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">push <span class="s2">&#34;redirect-gateway def1 bypass-dhcp&#34;</span>

push <span class="s2">&#34;dhcp-option DNS 208.67.222.222&#34;</span>
push <span class="s2">&#34;dhcp-option DNS 208.67.220.220&#34;</span></code></pre></div>
<p>默认情况下，使用 OpenDNS 解析程序。您可以更改它，比如使用 CloudFlare ， Google 或您想要的任何其他 DNS 解析器。</p></li>

<li><p>查找 <code>user</code> 和 <code>group</code> 指令并通过删除每行开头的 “<code>;</code>” 来取消注释这些设置;：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">user nobody
group nogroup</code></pre></div></li>

<li><p>在文件末尾附加以下行。该指令将消息验证算法 (HMAC）从 SHA1 更改为 SHA256</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">auth SHA256</code></pre></div></li>
</ul>

<p>完成后，服务器配置文件 <code>/etc/openvpn/server1.conf</code> 应如下所示（注释除外）：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">port <span class="m">1194</span>
proto udp
dev tun
ca ca.crt
cert server1.crt
key server1.key  <span class="c1"># This file should be kept secret</span>
dh dh.pem
server <span class="m">10</span>.8.0.0 <span class="m">255</span>.255.255.0
ifconfig-pool-persist /var/log/openvpn/ipp.txt
push <span class="s2">&#34;redirect-gateway def1 bypass-dhcp&#34;</span>
push <span class="s2">&#34;dhcp-option DNS 208.67.222.222&#34;</span>
push <span class="s2">&#34;dhcp-option DNS 208.67.220.220&#34;</span>
keepalive <span class="m">10</span> <span class="m">120</span>
tls-auth ta.key <span class="m">0</span> <span class="c1"># This file is secret</span>
cipher AES-256-CBC
user nobody
group nogroup
persist-key
persist-tun
status /var/log/openvpn/openvpn-status.log
verb <span class="m">3</span>
explicit-exit-notify <span class="m">1</span>
auth SHA256</code></pre></div>
<h2 id="启动-openvpn-服务">启动 OpenVPN 服务</h2>

<p>在本教程中，我们使用 <code>server1.conf</code> 作为配置文件。要使用此配置启动 OpenVPN 服务，我们需要在 systemd 单元文件名后指定配置文件名：</p>

<p>在 <strong>OpenVPN 服务器</strong>上运行以下命令以启动 OpenVPN 服务：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo systemctl start openvpn@server1</code></pre></div>
<p>输入以下命令验证服务是否已成功启动：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo systemctl status openvpn@server1</code></pre></div>
<p>如果服务处于活动状态并且正在运行，则输出将如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">● openvpn@server1.service - OpenVPN connection to server1
   Loaded: loaded <span class="o">(</span>/lib/systemd/system/openvpn@.service<span class="p">;</span> disabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
   Active: active <span class="o">(</span>running<span class="o">)</span> since Tue <span class="m">2019</span>-03-19 <span class="m">03</span>:49:53 PDT<span class="p">;</span> 3s ago
     Docs: man:openvpn<span class="o">(</span><span class="m">8</span><span class="o">)</span>
           https://community.openvpn.net/openvpn/wiki/Openvpn23ManPage
           https://community.openvpn.net/openvpn/wiki/HOWTO
  Process: <span class="m">1722</span> <span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/openvpn --daemon ovpn-server1 --status /run/openvpn/server1.status <span class="m">10</span> --cd /etc/openvpn --config /etc/openvpn/server1.conf --writepid /run/openvpn/server1.pid <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span><span class="m">0</span>/SUCCESS<span class="o">)</span>
 Main PID: <span class="m">1723</span> <span class="o">(</span>openvpn<span class="o">)</span>
    Tasks: <span class="m">1</span> <span class="o">(</span>limit: <span class="m">4915</span><span class="o">)</span>
   CGroup: /system.slice/system-openvpn.slice/openvpn@server1.service
           └─1723 /usr/sbin/openvpn --daemon ovpn-server1 --status /run/openvpn/server1.status <span class="m">10</span> --cd /etc/openvpn --config /etc/openvpn/server1.conf --writepid /run/openvpn/server1.pid</code></pre></div>
<p>使服务能够随机自启动：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo systemctl <span class="nb">enable</span> openvpn@server1</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Created symlink /etc/systemd/system/multi-user.target.wants/openvpn@server1.service → /lib/systemd/system/openvpn@.service.</code></pre></div>
<blockquote>
<p>如果 OpenVPN 服务无法启动，请通过命令 <code>sudo journalctl -u openvpn@server1</code> 检查日志</p>
</blockquote>

<p>启动时， OpenVPN Server 会创建一个 tun 设备 <code>tun0</code> 。要检查设备是否可用，请输入：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ip a show tun0</code></pre></div>
<p>输出应该如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="m">3</span>: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast state UNKNOWN group default qlen <span class="m">100</span>
    link/none 
    inet <span class="m">10</span>.8.0.1 peer <span class="m">10</span>.8.0.2/32 scope global tun0
       valid_lft forever preferred_lft forever</code></pre></div>
<p>此时，您的 OpenVPN 服务器已配置并正常运行。</p>

<h2 id="防火墙和服务器网络配置">防火墙和服务器网络配置</h2>

<p>为了正确转发网络数据包，我们需要启用 IP 转发。</p>

<p>在 <strong>OpenVPN 服务器</strong>上执行以下步骤。</p>

<p>打开 <code>/etc/sysctl.conf</code> 文件并添加行 <code>net.ipv4.ip_forward  = 0</code> 或取消该行的注释一遍能读取行：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo nano /etc/sysctl.conf</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Uncomment the next line to enable packet forwarding for IPv4</span>
net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span></code></pre></div>
<p>完成后，保存并关闭文件。</p>

<p>运行以下命令应用新设置：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo sysctl -p</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span></code></pre></div>
<p>如果您遵循先决条件，则应该已在服务器上运行 <!--link:how-to-setup-a-firewall-with-ufw-on-debian-9-->UFW 防火墙<!--link-->。</p>

<p>现在我们需要添加防火墙规则以启用伪装。这将允许流量离开 VPN ，使您的 VPN 客户端可以访问 Internet 。</p>

<p>在添加规则之前，您需要了解 Debian OpenVPN 服务器的公共网络接口。您可以通过运行以下命令轻松找到该接口：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ip -o -4 route show to default <span class="p">|</span> awk <span class="s1">&#39;{print $5}&#39;</span></code></pre></div>
<p>在我们的例子中，接口的名称是 <code>eth0</code> 如下面的输出所示。您的界面可能有不同的名称。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">eth0</code></pre></div>
<p>默认情况下，使用 UFW 时，转发的数据包将被丢弃。我们需要更改它并指示我们的防火墙允许转发的数据包。</p>

<p>打开 UFW 配置文件，找到 <code>DEFAULT_FORWARD_POLICY</code> 密钥并将值从 <code>DROP</code> 更改为 <code>ACCEPT</code> ：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo nano /etc/default/ufw</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">...
<span class="c1"># Set the default forward policy to ACCEPT, DROP or REJECT.  Please note that</span>
<span class="c1"># if you change this you will most likely want to adjust your rules</span>
<span class="nv">DEFAULT_FORWARD_POLICY</span><span class="o">=</span><span class="s2">&#34;ACCEPT&#34;</span>
...</code></pre></div>
<p>接下来，我们需要在 nat 表中为 <code>POSTROUTING</code>链设置的默认策略并设置伪装规则。</p>

<p>为此，请打开 <code>/etc/ufw/before.rules</code> 文件并附加以黄色突出显示的行，如下所示。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo nano /etc/ufw/before.rules</code></pre></div>
<p>不要忘了将 <code>-A POSTROUTING</code> 行中的 <code>eth0</code> 替换为您在前面的命令中找到的公共网络接口的名称。粘贴在最后一行 <code>COMMIT</code> 开头的行之后。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">...
<span class="c1"># don&#39;t delete the &#39;COMMIT&#39; line or these rules won&#39;t be processed</span>
COMMIT

<span class="c1">#NAT table rules</span>
*nat
:POSTROUTING ACCEPT <span class="o">[</span><span class="m">0</span>:0<span class="o">]</span>

<span class="c1"># Forward traffic through eth0 - Change to public network interface</span>
-A POSTROUTING -s <span class="m">10</span>.8.0.0/16 -o eth0 -j MASQUERADE

<span class="c1"># don&#39;t delete the &#39;COMMIT&#39; line or these rules won&#39;t be processed</span>
COMMIT</code></pre></div>
<p>完成后，保存并关闭文件。</p>

<p>我们还需要在端口上打开 UDP 流量， <code>1194</code> 这是默认的 OpenVPN 端口。为此，请运行以下命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo ufw allow <span class="m">1194</span>/udp</code></pre></div>
<p>为避免因为您忘记打开 SSH 端口被锁定，请运行以下命令以打开端口：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo ufw allow OpenSSH</code></pre></div>
<p>最后通过禁用和重新启用 UFW 来重新加载 UFW 规则：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo ufw disable
sudo ufw enable</code></pre></div>
<p>要验证更改，请运行以下命令以列出 <code>POSTROUTING</code> 规则：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo iptables -nvL POSTROUTING -t nat</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Chain POSTROUTING <span class="o">(</span>policy ACCEPT <span class="m">0</span> packets, <span class="m">0</span> bytes<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
    <span class="m">0</span>     <span class="m">0</span> MASQUERADE  all  --  *      eth0    <span class="m">10</span>.8.0.0/16          <span class="m">0</span>.0.0.0/0  </code></pre></div>
<h2 id="创建客户端配置基础结构">创建客户端配置基础结构</h2>

<p>在本教程中，我们将创建一个单独的 SSL 证书，并为每个 VPN 客户端生成不同的配置文件。</p>

<p>客户端私钥和证书请求可以在客户端计算机上或服务器上生成。为简单起见，我们将在服务器上生成证书请求，然后将其发送给 CA 进行签名。</p>

<p>生成客户端证书和配置文件的整个过程如下：</p>

<ol>
<li>在 OpenVPN 服务器上生成私钥和证书请求。</li>
<li>将请求发送到要签名的 CA 计算机。</li>
<li>将签名的 SSL 证书复制到 OpenVPN 服务器并生成配置文件。</li>
<li>将配置文件发送到 VPN 客户端的计算机。</li>
</ol>

<p>首先创建一组目录来存储客户端文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">mkdir -p ~/openvpn-clients/<span class="o">{</span>configs,base,files<span class="o">}</span></code></pre></div>
<ul>
<li><code>base</code> 目录将存储所有客户端文件之间共享的基本文件和配置。</li>
<li><code>configs</code> 目录将存储生成的客户端配置。</li>
<li><code>files</code> 目录将存储客户端特定的证书/密钥对。</li>
</ul>

<p>将 <code>ca.crt</code> 和 <code>ta.key</code> 文件复制到 <code>~/openvpn-clients/base</code> 目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">cp ~/EasyRSA-v3.0.6/ta.key ~/openvpn-clients/base/
cp /etc/openvpn/ca.crt ~/openvpn-clients/base/</code></pre></div>
<p>接下来，将示例 VPN 客户端配置文件复制到客户端 <code>~/openvpn-clients/base</code> 目录中。我们将使用此文件作为基本配置：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf ~/openvpn-clients/base/</code></pre></div>
<p>现在我们需要编辑文件以匹配我们的服务器设置和配置。使用文本编辑器打开配置文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">nano ~/openvpn-clients/base/client.conf</code></pre></div>
<ul>
<li><p>找到 <code>remote</code> 指令并使用 OpenVPN 服务器的公共 IP 地址更改默认占位符：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># The hostname/IP and port of the server.</span>
<span class="c1"># You can have multiple remote entries</span>
<span class="c1"># to load balance between the servers.</span>
remote YOUR_SERVER_IP <span class="m">1194</span></code></pre></div></li>

<li><p>找到并注释掉 <code>ca</code> ， <code>cert</code> 和 <code>key</code> 指令。证书和密钥将添加到配置文件中：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># SSL/TLS parms.</span>
<span class="c1"># See the server config file for more</span>
<span class="c1"># description.  It&#39;s best to use</span>
<span class="c1"># a separate .crt/.key file pair</span>
<span class="c1"># for each client.  A single ca</span>
<span class="c1"># file can be used for all clients.</span>
<span class="c1"># ca ca.crt</span>
<span class="c1"># cert client.crt</span>
<span class="c1"># key client.key</span></code></pre></div></li>

<li><p>在文件末尾附加以下行以匹配服务器设置：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">auth SHA256</code></pre></div></li>
</ul>

<p>完成后，服务器配置文件 <code>~/openvpn-clients/base/client.conf</code> 应如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">client
dev tun
proto udp
remote YOUR_SERVER_IP <span class="m">1194</span>
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher AES-256-CBC
verb <span class="m">3</span>
auth SHA256
key-direction <span class="m">1</span></code></pre></div>
<p>接下来，创建一个简单的 bash 脚本，它将基本配置和文件与客户端证书和密钥合并，并将生成的配置存储在 <code>~/openvpn-clients/configs</code> 目录中。</p>

<p>打开文本编辑器并创建以下脚本：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">nano ~/openvpn-clients/gen_config.sh</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="nv">FILES_DIR</span><span class="o">=</span><span class="nv">$HOME</span>/openvpn-clients/files
<span class="nv">BASE_DIR</span><span class="o">=</span><span class="nv">$HOME</span>/openvpn-clients/base
<span class="nv">CONFIGS_DIR</span><span class="o">=</span><span class="nv">$HOME</span>/openvpn-clients/configs

<span class="nv">BASE_CONF</span><span class="o">=</span><span class="si">${</span><span class="nv">BASE_DIR</span><span class="si">}</span>/client.conf
<span class="nv">CA_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">BASE_DIR</span><span class="si">}</span>/ca.crt
<span class="nv">TA_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">BASE_DIR</span><span class="si">}</span>/ta.key

<span class="nv">CLIENT_CERT</span><span class="o">=</span><span class="si">${</span><span class="nv">FILES_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">1</span><span class="si">}</span>.crt
<span class="nv">CLIENT_KEY</span><span class="o">=</span><span class="si">${</span><span class="nv">FILES_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">1</span><span class="si">}</span>.key

<span class="c1"># Test for files</span>
<span class="k">for</span> i in <span class="s2">&#34;</span><span class="nv">$BASE_CONF</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$CA_FILE</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$TA_FILE</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$CLIENT_CERT</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$CLIENT_KEY</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[[</span> ! -f <span class="nv">$i</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&#34; The file </span><span class="nv">$i</span><span class="s2"> does not exist&#34;</span>
        <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[[</span> ! -r <span class="nv">$i</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&#34; The file </span><span class="nv">$i</span><span class="s2"> is not readable.&#34;</span>
        <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># Generate client config</span>
cat &gt; <span class="si">${</span><span class="nv">CONFIGS_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">1</span><span class="si">}</span>.ovpn <span class="s">&lt;&lt;EOF
</span><span class="s">$(cat ${BASE_CONF})
</span><span class="s">&lt;key&gt;
</span><span class="s">$(cat ${CLIENT_KEY})
</span><span class="s">&lt;/key&gt;
</span><span class="s">&lt;cert&gt;
</span><span class="s">$(cat ${CLIENT_CERT})
</span><span class="s">&lt;/cert&gt;
</span><span class="s">&lt;ca&gt;
</span><span class="s">$(cat ${CA_FILE})
</span><span class="s">&lt;/ca&gt;
</span><span class="s">&lt;tls-auth&gt;
</span><span class="s">$(cat ${TA_FILE})
</span><span class="s">&lt;/tls-auth&gt;
</span><span class="s">EOF</span></code></pre></div>
<p>保存文件并运行以下命名使其可执行：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">chmod u+x ~/openvpn-clients/gen_config.sh</code></pre></div>
<h2 id="创建客户端证书私钥和配置">创建客户端证书私钥和配置</h2>

<p>生成客户端私钥和证书请求的过程与生成服务器密钥和证书请求时的过程相同。</p>

<p>正如我们在上一节中已经提到的，我们将在 OpenVPN 服务器上生成客户端私钥和证书请求。在此示例中，第一个 VPN 客户端的名称将是 <code>client1</code> 。</p>

<ol>
<li><p>导航到 <strong>OpenVPN 服务器</strong>上的 EasyRSA 目录，并为客户端生成新的私钥和证书请求文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6/
./easyrsa gen-req client1 nopass</code></pre></div>
<p>该命令将创建两个文件，一个私钥 (<code>client1.key</code>) 和一个证书请求文件 (<code>client1.req</code>)。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Common Name <span class="o">(</span>eg: your user, host, or server name<span class="o">)</span> <span class="o">[</span>client1<span class="o">]</span>:

Keypair and certificate request completed. Your files are:
req: /home/serveruser/EasyRSA-v3.0.6/pki/reqs/client1.req
key: /home/serveruser/EasyRSA-v3.0.6/pki/private/client1.key</code></pre></div></li>

<li><p>将私钥 <code>client1.key</code> 复制到您在上一节中创建的目录 <code>~/openvpn-clients/files</code> ：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">cp ~/EasyRSA-v3.0.6/pki/private/client1.key ~/openvpn-clients/files/</code></pre></div></li>

<li><p>将证书请求文件传输到 CA 计算机：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">scp ~/EasyRSA-v3.0.6/pki/reqs/client1.req causer@your_ca_ip:/tmp</code></pre></div>
<p>在此示例中，我们使用 <code>scp</code> 传输文件，您也可以使用运行在 ssh 之上 <code>rsync</code> 或任何其他安全方法。</p></li>

<li><p>登录到您的 <strong>CA 计算机</strong>，切换到 EasyRSA 目录并导入证书请求文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6
./easyrsa import-req /tmp/client1.req client1</code></pre></div>
<p>第一个参数是证书请求文件的路径，第二个参数是客户端名称。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">The request has been successfully imported with a short name of: client1
You may now use this name to perform signing operations on this request.</code></pre></div></li>

<li><p>在 <strong>CA 计算机</strong>上的 EasyRSA 目录中，运行以下命令以对请求进行签名：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/EasyRSA-v3.0.6
./easyrsa sign-req client client1</code></pre></div>
<p>系统将提示您验证请求是否来自可信来源。输入 <code>yes</code> 并按 <code>enter</code> 确认：</p>

<p>如果您的 CA 密钥受密码保护，系统将提示您输入密码。验证后，脚本将生成 SSL 证书并打印完整路径。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">...
Certificate created at: /home/causer/EasyRSA-v3.0.6/pki/issued/client1.crt</code></pre></div></li>

<li><p>接下来，将签名的证书 <code>client1.crt</code> 文件传输回 OpenVPN 服务器。您可以使用 scp ， rsync 或任何其他安全的方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">scp ~/EasyRSA-v3.0.6/pki/issued/client1.crt serveruser@your_server_ip:/tmp</code></pre></div></li>

<li><p>登录到您的 <strong>OpenVPN 服务器</strong>，并将 <code>client1.crt</code> 文件移动到 <code>~/openvpn-clients/files</code> 目录中：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">mv /tmp/client1.crt ~/openvpn-clients/files</code></pre></div></li>

<li><p>最后一步是使用 <code>gen_config.sh</code> 脚本生成客户端配置。切换到 <code>~/openvpn-clients</code> 目录并使用客户端名称作为参数运行脚本：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~/openvpn-clients
./gen_config.sh client1</code></pre></div>
<p>该脚本将在目录 <code>~/client-configs/configs</code> 中创建指定的文件 <code>client1.ovpn</code> 。您可以通过列出目录来检查：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ls ~/openvpn-clients/configs</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">client1.ovpn</code></pre></div></li>
</ol>

<p>此时，客户端配置创建完成了。您现在可以将配置文件传输到要用作客户端的设备。</p>

<p>例如，要将配置文件传输到本地计算机，scp应运行以下命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">scp ~/client-configs/files/client1.ovpn your_local_ip:/</code></pre></div>
<p>要添加其他客户端，只需重复相同的步骤即可。</p>

<h2 id="连接客户端">连接客户端</h2>

<h3 id="linux">Linux</h3>

<p>您的系统或桌面环境可能提供工具或图形用户界面以连接到 OpenVPN 服务器。在本教程中，我们将向您展示如何使用该 openvpn 工具连接到服务器。</p>

<ul>
<li><p>在 Ubuntu 和 Debian 上安装 OpenVPN</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt update
sudo apt install openvpn</code></pre></div></li>

<li><p>在 CentOS 和 Fedora 上安装 OpenVPN</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo yum install epel-release
sudo yum install openvpn</code></pre></div></li>
</ul>

<p>安装软件包后，要连接到 VPN 服务器，请使用该 openvpn 命令并指定客户端配置文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo openvpn --config client1.ovpn</code></pre></div>
<h3 id="苹果系统">苹果系统</h3>

<p><a href="https://tunnelblick.net/">Tunnelblick</a> 是 OS X 和 macOS 上 OpenVPN 的免费开源图形用户界面。</p>

<h3 id="windows">Windows</h3>

<p>在 <a href="https://openvpn.net/community-downloads/">OpenVPN 的下载页面</a>下载并安装最新版本的 OpenVPN 应用程序。</p>

<p>将 <code>.ovpn</code> 文件复制到 OpenVPN 配置文件夹 (<code>\Users\&lt;Name&gt;\OpenVPN\Config</code> 或 <code>\Program Files\OpenVPN\config</code>)。</p>

<p>启动 OpenVPN 应用程序。</p>

<p>右键单击 OpenVPN 系统托盘图标，您复制的 OpenVPN 配置文件的名称将列在菜单上。单击连接。</p>

<h3 id="android-和-ios">Android 和 iOS</h3>

<p>由 OpenVPN 开发的 VPN 应用程序适用于 Android 和 iOS 。安装应用程序并导入客户端 <code>.ovp</code> 文件。</p>

<ul>
<li><a href="https://play.google.com/store/apps/details?id=net.openvpn.openvpn">Android OpenVPN Connect</a></li>
<li><a href="https://itunes.apple.com/us/app/openvpn-connect/id590379981">iOS OpenVPN Connect</a></li>
</ul>

<h2 id="撤销客户证书">撤销客户证书</h2>

<p>撤销证书意味着使签名证书无效，以便它不能再用于访问 OpenVPN 服务器。</p>

<p>要撤消客户端证书，请按照以下步骤操作：</p>

<ol>
<li><p>登录到您的 <strong>CA 计算机</strong>并切换到 EasyRSA 目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> EasyRSA-v3.0.6</code></pre></div></li>

<li><p>使用 <code>revoke</code> 参数运行 easyrsa 脚本，后台跟上要撤消的客户端名称：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">./easyrsa revoke client1</code></pre></div>
<p>系统将提示您确认是否要撤消证书。输入 <code>yes</code> 并按 <code>enter</code> 确认：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Please confirm you wish to revoke the certificate with the following subject:

<span class="nv">subject</span><span class="o">=</span>
    <span class="nv">commonName</span>                <span class="o">=</span> client1

Type the word <span class="s1">&#39;yes&#39;</span> to <span class="k">continue</span>, or any other input to abort.
Continue with revocation: yes
...</code></pre></div>
<p>如果您的 CA 密钥受密码保护，系统将提示您输入密码。验证后，脚本将撤消证书。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">...
Revocation was successful. You must run gen-crl and upload a CRL to your
infrastructure in order to prevent the revoked cert from being accepted.</code></pre></div></li>

<li><p>使用该 <code>gen-crl</code> 选项生成证书吊销列表 (CR) ：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">./easyrsa gen-crl</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">An updated CRL has been created.
CRL file: /home/causer/EasyRSA-v3.0.6/pki/crl.pem</code></pre></div></li>

<li><p>将 CRL 文件上载到 OpenVPN 服务器：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">scp ~/EasyRSA-v3.0.6/pki/crl.pem serveruser@your_server_ip:/tmp</code></pre></div></li>

<li><p>登录您的 <strong>OpenVPN 服务器</strong>并将文件移动到 <code>/etc/openvpn</code> 目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo mv /tmp/crl.pem /etc/openvpn</code></pre></div></li>

<li><p>打开 OpenVPN 服务器配置文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo nano /etc/openvpn/server1.conf</code></pre></div>
<p>将以下行粘贴到文件末尾</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">/etc/openvpn/server1.conf
crl-verify crl.pem</code></pre></div>
<p>保存并关闭文件。</p></li>

<li><p>重新启动 OpenVPN 服务以使吊销指令生效：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo systemctl restart openvpn@server1</code></pre></div>
<p>此时，客户端应该不再能够使用已撤销的证书访问 OpenVPN 服务器。</p></li>
</ol>

<p>如果您需要撤销其他客户端证书，请重复相同的步骤。</p>

<h2 id="结论">结论</h2>

<p>在本教程中，您学习了如何在 Debian 9 计算机上安装和配置 OpenVPN 服务器。</p>
      </div><ul class="pa0">
  
   <li class="list di">
     <a href="/tags/debian" class="link f5 grow no-underline br2 ba ph3 pv2 mb3 mr2 dib white bg-white sans-serif">debian</a>
   </li>
  
   <li class="list di">
     <a href="/tags/vpn" class="link f5 grow no-underline br2 ba ph3 pv2 mb3 mr2 dib white bg-white sans-serif">vpn</a>
   </li>
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l">




  <div class="x-related bg-near-white pa3 pb1 nested-copy-line-height nested-links mb3">
    <p class="f5 mb3 mt0">相关阅读</p>
    <ul class="pa0 list">
	   
	     <li  class="mv1 truncate">
          <a href="/linux/how-to-install-tomcat-8-5-on-debian-9/">如何在 Debian 9 上安装 Tomcat 8.5</a>
        </li>
	    
	     <li  class="mv1 truncate">
          <a href="/linux/how-to-install-wildfly-on-debian-9/">如何在 Debian 9 上安装 WildFly (JBoss)</a>
        </li>
	    
	     <li  class="mv1 truncate">
          <a href="/linux/how-to-set-or-change-timezone-on-debian-9/">如何在 Debian 9 上设置或更改时区</a>
        </li>
	    
	     <li  class="mv1 truncate">
          <a href="/linux/how-to-add-and-delete-users-on-debian-9/">如何在 Debian 9 上添加和删除用户</a>
        </li>
	    
	     <li  class="mv1 truncate">
          <a href="/linux/install-java-on-debian-9/">如何在 Debian 9 上安装 Java</a>
        </li>
	    
	     <li  class="mv1 truncate">
          <a href="/linux/how-to-install-plex-media-server-on-debian-9/">如何在 Debian 9 上安装 Plex 媒体服务器</a>
        </li>
	    
	     <li  class="mv1 truncate">
          <a href="/linux/how-to-install-gradle-on-debian-9/">如何在 Debian 9 上安装 Gradle</a>
        </li>
	    
	     <li  class="mv1 truncate">
          <a href="/linux/how-to-install-vagrant-on-debian-9/">如何在 Debian 9 上安装 Vagrant</a>
        </li>
	    
    </ul>
</div>

<div class="sticky">
  <div class="x-toc bg-near-white pa3 pb1 nested-list-reset nested-links f5">
    <p class="f5 mb3 mt0">文章目录</p>
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#先决条件">先决条件</a></li>
<li><a href="#使用-easyrsa-构建-ca">使用 EasyRSA 构建 CA.</a></li>
<li><a href="#安装-openvpn-和-easyrsa">安装 OpenVPN 和 EasyRSA</a></li>
<li><a href="#创建-diffie-hellman-和-hmac-密钥">创建 Diffie-Hellman 和 HMAC 密钥</a></li>
<li><a href="#创建服务器证书和私钥">创建服务器证书和私钥</a></li>
<li><a href="#配置-openvpn-服务">配置 OpenVPN 服务</a></li>
<li><a href="#启动-openvpn-服务">启动 OpenVPN 服务</a></li>
<li><a href="#防火墙和服务器网络配置">防火墙和服务器网络配置</a></li>
<li><a href="#创建客户端配置基础结构">创建客户端配置基础结构</a></li>
<li><a href="#创建客户端证书私钥和配置">创建客户端证书私钥和配置</a></li>
<li><a href="#连接客户端">连接客户端</a>
<ul>
<li><a href="#linux">Linux</a></li>
<li><a href="#苹果系统">苹果系统</a></li>
<li><a href="#windows">Windows</a></li>
<li><a href="#android-和-ios">Android 和 iOS</a></li>
</ul></li>
<li><a href="#撤销客户证书">撤销客户证书</a></li>
<li><a href="#结论">结论</a></li>
</ul></li>
</ul>
</nav>
  </div>
  </div></aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="/" >
    &copy; 2019 不争笔记
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
